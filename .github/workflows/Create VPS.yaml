name: Create VPS with Direct SSH (Pinggy Persistent Subdomain)

on:
  workflow_dispatch:

jobs:
  start-vps:
    runs-on: ubuntu-latest
    steps:
      - name: ‚¨áÔ∏è Checkout
        uses: actions/checkout@v3

      - name: üìÅ Prepare dirs
        run: mkdir -p links .backup

      - name: ‚úÖ Install OpenSSH & Create User
        run: |
          sudo apt update -y
          sudo apt install -y openssh-server
          sudo useradd -m vpsuser
          PASSWORD="$(openssl rand -base64 10)"
          echo "vpsuser:$PASSWORD" | sudo chpasswd
          echo "$PASSWORD" > links/ssh_password.txt
          sudo sed -i 's/Port 22/Port 2222/' /etc/ssh/sshd_config
          sudo systemctl restart ssh

      - name: üöÄ Start pinggy Tunnel (Persistent Subdomain)
        run: |
          curl -fsSL https://pinggy.io/install.sh | bash
          # Jalankan pinggy dengan subdomain dan token, port 2222
          nohup pinggy tcp -a bmfYULN6dqT -s nsgcubuczg.a.pinggy.link 2222 > pinggy.log 2>&1 &
          sleep 10   # tunggu tunnel aktif

      - name: üì§ Output SSH Info (Persistent Subdomain)
        run: |
          USER="vpsuser"
          PASS=$(cat links/ssh_password.txt)
          HOST="nsgcubuczg.a.pinggy.link"
          PORT="2222"
          echo "==== SSH LOGIN INFO ====" > links/ssh_info.txt
          echo "Username: $USER" >> links/ssh_info.txt
          echo "Password: $PASS" >> links/ssh_info.txt
          echo "Host: $HOST" >> links/ssh_info.txt
          echo "Port: $PORT" >> links/ssh_info.txt
          cat links/ssh_info.txt

      - name: ‚è≥ Keep VPS alive
        run: |
          i=1
          while [ $i -le 360 ]; do
            echo "üü¢ Running minute $i/360..."
            command sleep 60 || break
            i=$((i+1))
          done
