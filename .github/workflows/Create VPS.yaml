name: Start Persistent Pinggy Tunnel

on:
  workflow_dispatch:

jobs:
  tunnel:
    runs-on: ubuntu-latest
    steps:
      - name: ‚úÖ Install OpenSSH & Create User
        run: |
          sudo apt update -y
          sudo apt install -y openssh-server
          sudo useradd -m vpsuser
          PASSWORD="$(openssl rand -base64 10)"
          echo "vpsuser:$PASSWORD" | sudo chpasswd
          echo "$PASSWORD" > ssh_password.txt
          sudo sed -i 's/Port 22/Port 2222/' /etc/ssh/sshd_config
          sudo systemctl restart ssh

      - name: üöÄ Start persistent Pinggy tunnel (while true)
        run: |
          sudo apt-get install -y openssh-client
          while true; do
            ssh -p 443 \
              -R0:localhost:3000 \
              -L4300:localhost:4300 \
              -o StrictHostKeyChecking=no \
              -o ServerAliveInterval=30 \
              bmfYULN6dqT@pro.pinggy.io
            echo "Tunnel disconnected. Reconnecting in 10 seconds..."
            sleep 10
          done &
          sleep 15

      - name: üì§ Output SSH Info
        run: |
          USER="vpsuser"
          PASS=$(cat ssh_password.txt)
          echo "==== SSH LOGIN INFO ===="
          echo "Username: $USER"
          echo "Password: $PASS"
          echo "Host: [lihat log tunnel]"
          echo "Port: 3000 (reverse) / 4300 (local forward)"

      - name: ‚è≥ Keep VPS alive
        run: |
          i=1
          while [ $i -le 360 ]; do
            echo "üü¢ Running minute $i/360..."
            sleep 60
            i=$((i+1))
          done
